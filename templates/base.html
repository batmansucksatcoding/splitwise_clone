{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Splitwise{% endblock %}</title>


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="icon" href="{% static 'images/favicon.png' %}">
</head>

<body class="bg-light d-flex flex-column min-vh-100">


  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">

      <a class="navbar-brand fw-bold d-flex align-items-center"
         href="{% if user.is_authenticated %}{% url 'dashboard' %}{% else %}{% url 'home' %}{% endif %}">
        ðŸ’¸ <span class="ms-2">Splitwise</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
              aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarContent">
        <ul class="navbar-nav mb-2 mb-lg-0 align-items-lg-center">
          {% if user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'dashboard' %}">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'friends_list' %}">Friends</a></li>

            <li class="nav-item ms-lg-3">
              <form class="d-flex" action="{% url 'accounts:search_friends' %}" method="get" role="search">
                <input class="form-control me-2" type="search" name="q" placeholder="Find friends..." required>
                <button class="btn btn-outline-light btn-sm" type="submit">Search</button>
              </form>
            </li>

            <li class="nav-item ms-lg-3">
              <div class="notification-wrapper">
                  <a href="{% url 'notifications:notification_list' %}" class="notification-bell" id="notificationBell">
                      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M15 6.66667C15 5.34058 14.4732 4.06881 13.5355 3.13113C12.5979 2.19345 11.3261 1.66667 10 1.66667C8.67392 1.66667 7.40215 2.19345 6.46447 3.13113C5.52678 4.06881 5 5.34058 5 6.66667C5 12.5 2.5 14.1667 2.5 14.1667H17.5C17.5 14.1667 15 12.5 15 6.66667Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M11.4417 17.5C11.2952 17.7526 11.0849 17.9622 10.8319 18.1079C10.5789 18.2537 10.292 18.3304 10 18.3304C9.70802 18.3304 9.42111 18.2537 9.16812 18.1079C8.91514 17.9622 8.70484 17.7526 8.55835 17.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                  </a>
                  
                  <div class="notification-dropdown" id="notificationDropdown">
                      <div class="dropdown-header">
                          <h3>Notifications</h3>
                          <a href="{% url 'notifications:notification_list' %}" class="view-all-link">View All</a>
                      </div>
                      <div class="dropdown-body" id="notificationList">
                          <div class="loading-state">
                              <div class="spinner"></div>
                              <p>Loading notifications...</p>
                          </div>
                      </div>
                      <div class="dropdown-footer">
                          <a href="{% url 'notifications:notification_preferences' %}" class="settings-link">
                              <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <circle cx="7" cy="7" r="2.5" stroke="currentColor" stroke-width="1.3"/>
                                  <path d="M7 1V2M7 12V13M13 7H12M2 7H1M11.303 11.303L10.596 10.596M3.404 3.404L2.697 2.697M11.303 2.697L10.596 3.404M3.404 10.596L2.697 11.303" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
                              </svg>
                              Notification Settings
                          </a>
                      </div>
                  </div>
              </div>
            </li>

            <li class="nav-item ms-lg-3">
              <form action="{% url 'logout' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-link nav-link text-danger p-0">Logout</button>
              </form>
            </li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'register' %}">Register</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% block content %}{% endblock %}
  </div>


  <footer class="mt-auto py-3 bg-dark text-center text-white-50">
    <small>Â© 2025 Splitwise â€¢ Built with 
      <a href="https://www.djangoproject.com/" class="text-decoration-none text-info">Django</a>
    </small>
  </footer>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function() {
      let notificationCheckInterval;

      function updateNotifications() {
          fetch('{% url "notifications:get_unread" %}')
              .then(response => response.json())
              .then(data => {
                  const badge = document.getElementById('notificationCount');
                  if (data.unread_count > 0) {
                      badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                      badge.style.display = 'flex';
                  } else {
                      badge.style.display = 'none';
                  }
                  updateNotificationList(data.notifications);
              });
      }

      function updateNotificationList(notifications) {
          const listContainer = document.getElementById('notificationList');
          if (notifications.length === 0) {
              listContainer.innerHTML = `
                  <div class="empty-state"><p>No new notifications</p></div>
              `;
              return;
          }
          listContainer.innerHTML = notifications.map(notif => `
              <div class="notification-item unread" onclick="handleNotificationClick(${notif.id}, '${notif.action_url}')">
                  <div class="notification-item-header">
                      <span class="notification-item-icon">${notif.icon}</span>
                      <span class="notification-item-time">${getTimeAgo(notif.created_at)}</span>
                  </div>
                  <div class="notification-item-content">
                      <div class="notification-item-title">${escapeHtml(notif.title)}</div>
                      <div class="notification-item-message">${escapeHtml(notif.message)}</div>
                  </div>
              </div>
          `).join('');
      }

      window.handleNotificationClick = function(id, actionUrl) {
          fetch(`/notifications/${id}/read/`, {
              method: 'POST',
              headers: {'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest'}
          }).then(() => {
              if (actionUrl) window.location.href = actionUrl;
          });
      };

      function getTimeAgo(dateString) {
          const date = new Date(dateString);
          const now = new Date();
          const seconds = Math.floor((now - date) / 1000);
          if (seconds < 60) return 'just now';
          if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
          if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
          return `${Math.floor(seconds / 86400)}d ago`;
      }

      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
      }

      function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
      }

      document.addEventListener('DOMContentLoaded', function() {
          updateNotifications();
          notificationCheckInterval = setInterval(updateNotifications, 30000);
      });
      window.addEventListener('beforeunload', () => clearInterval(notificationCheckInterval));
  })();
  </script>

  <style>
.notification-wrapper {
  position: relative;
}

.notification-bell {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  border-radius: 10px;
  background-color: transparent;
  color: #f9fafb; 
  transition: all 0.3s ease;
  text-decoration: none;
}

.notification-bell svg {
  stroke: currentColor;
}

.notification-bell:hover {
  color: #1abc9c;
  background-color: rgba(255, 255, 255, 0.1);
}

.notification-badge {
  position: absolute;
  top: 2px;
  right: 4px;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  height: 18px;
  display: none;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
}

.notification-dropdown {
  position: absolute;
  top: calc(100% + 12px);
  right: 0;
  width: 380px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  border: 1px solid #e5e7eb;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  z-index: 1000;
}

.notification-wrapper:hover .notification-dropdown {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #f3f4f6;
}

.dropdown-header h3 {
  font-size: 1.1rem;
  font-weight: 700;
  color: #111827;
  margin: 0;
}

.view-all-link {
  color: #1abc9c;
  font-size: 0.85rem;
  font-weight: 600;
  text-decoration: none;
}

.dropdown-body {
  max-height: 360px;
  overflow-y: auto;
}

.notification-item {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: background 0.2s ease;
}

.notification-item:hover {
  background-color: #f9fafb;
}

.notification-item.unread {
  background-color: #f0fdfa;
  border-left: 4px solid #1abc9c;
}

.notification-item-title {
  font-weight: 600;
  font-size: 0.9rem;
  color: #111827;
}

.notification-item-message {
  color: #6b7280;
  font-size: 0.85rem;
  margin-top: 2px;
}

.dropdown-footer {
  padding: 0.75rem 1.25rem;
  border-top: 1px solid #f3f4f6;
  background-color: #f9fafb;
  text-align: right;
}

.settings-link {
  color: #6b7280;
  font-size: 0.85rem;
  font-weight: 600;
  text-decoration: none;
}

.settings-link:hover {
  color: #1abc9c;
}
</style>

</body>
</html>
